<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>Ada çš„æ³•å¾‹èµ„æ–™ä¸»é¡µ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: "Helvetica Neue","PingFang SC","Microsoft YaHei",sans-serif;
  background:#f2f4f7;
  margin:0;
  padding:20px;
  color:#333;
  line-height:1.5;
}

h1 {
  color:#003366;
  font-size:22px;
  text-align:center;
  margin:0 0 10px;
}

p {
  text-align:center;
  font-size:13px;
  color:#666;
  margin:0 0 16px;
}

#searchInput {
  display:block;
  margin:0 auto 10px;
  padding:10px 16px;
  width:90%;
  max-width:500px;
  border:1px solid #ccc;
  border-radius:24px;
  font-size:14px;
}

#loading {
  text-align:center;
  font-size:13px;
  color:#999;
  margin-bottom:10px;
}

/* åˆ—è¡¨æ•´ä½“æ˜¯ç½‘æ ¼å¸ƒå±€ */
ul#mhtmlList {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:16px;
  list-style:none;
  padding:0;
  margin:0;
}

ul#mhtmlList li {
  background:#fff;
  border-radius:10px;
  padding:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  font-size:14px;
}

/* åˆ†ç»„æ ‡é¢˜ï¼šå æ»¡æ•´è¡Œ */
ul#mhtmlList li.group-header {
  grid-column:1 / -1;
  background:transparent;
  box-shadow:none;
  padding:4px 2px;
  font-size:13px;
  font-weight:600;
  color:#555;
  border-left:4px solid #007acc;
}

ul#mhtmlList li a {
  color:#007acc;
  font-weight:600;
  text-decoration:none;
  word-break:break-all;
}

ul#mhtmlList li a:hover {
  text-decoration:underline;
}

.file-date {
  margin-top:6px;
  font-size:12px;
  color:#2e8b57; /* ç»¿è‰²æ—¶é—´ */
}

#noResults {
  display:none;
  text-align:center;
  font-size:13px;
  color:#888;
  margin-top:20px;
}

/* è¿”å›é¡¶éƒ¨ / åº•éƒ¨æŒ‰é’® */
.scroll-buttons {
  position:fixed;
  right:20px;
  bottom:40px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:999;
}

.scroll-buttons button {
  background:#007acc;
  color:white;
  border:none;
  border-radius:20px;
  padding:6px 12px;
  font-size:13px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}
.scroll-buttons button:hover {
  background:#005fa3;
}
</style>
</head>

<body>
  <h1>Ada çš„æ³•å¾‹èµ„æ–™ä¸»é¡µ</h1>
  <p>ä»¥ä¸‹èµ„æ–™ä»…ä¾›å­¦ä¹ ç ”ç©¶ä½¿ç”¨ï¼Œç‚¹å‡»å¯ç›´æ¥æ‰“å¼€ã€‚</p>

  <input id="searchInput" placeholder="ğŸ” æ ¹æ®æ ‡é¢˜æœç´¢â€¦" />
  <div id="loading">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™â€¦</div>

  <ul id="mhtmlList"></ul>
  <div id="noResults">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>

  <!-- è¿”å›é¡¶éƒ¨ / åº•éƒ¨ -->
  <div class="scroll-buttons">
    <button onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">â†‘ è¿”å›é¡¶éƒ¨</button>
    <button onclick="window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' })">â†“ è·³åˆ°åº•éƒ¨</button>
  </div>

<script>
/* ========= åŸºæœ¬é…ç½® ========= */
const owner  = "Ada-Ren";
const repo   = "personal-legal-archive";
const folder = "mhtml";
const EXTS   = [".html",".pdf",".mhtml",".mht"];

/* æœ¬åœ°ç¼“å­˜é…ç½®ï¼š10 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ GitHub åˆ—è¡¨ */
const CACHE_KEY      = "ada_mhtml_cache_v2";
const CACHE_TIME_KEY = "ada_mhtml_cache_time_v2";
const CACHE_TTL_MS   = 10 * 60 * 1000; // 10 åˆ†é’Ÿ

/* ========= å·¥å…·å‡½æ•° ========= */

// æ–‡ä»¶åè½¬æ ‡é¢˜ï¼šå»æ‰åç¼€ + å»æ‰å‰ç¼€æ—¥æœŸ + æ›¿æ¢ä¸‹åˆ’çº¿/ä¸­åˆ’çº¿ä¸ºç©ºæ ¼
function filenameToTitle(name) {
  // å»æ‰æ‰©å±•å
  let base = name.replace(/\.(html?|pdf|mhtml?)$/i, "");

  // å»æ‰æ–‡ä»¶åå‰ç¼€çš„æ—¥æœŸéƒ¨åˆ†ï¼ˆä¾‹å¦‚ "20250101 " / "2025-01-01_" ç­‰ï¼‰
  base = base.replace(
    /^(20\d{2}(?:[-_]?(\d{2}))?(?:[-_]?(\d{2}))?)[\s_\-]*/,
    ""
  );

  // å‰©ä¸‹çš„å½“ä½œæ ‡é¢˜
  return base
    .replace(/[_\-]+/g, " ")
    .trim();
}

// ä»æ–‡ä»¶åæå–æ—¥æœŸï¼šæ”¯æŒ 2025 / 2025-01 / 2025-01-31 / 202501 / 20250131 / 2025_01_31
function extractDate(name) {
  const m = name.match(/^(20\d{2})(?:[-_]?(\d{2}))?(?:[-_]?(\d{2}))?/);
  if (!m) return null;

  const y  = m[1];
  const mo = m[2] || "01";
  const d  = m[3] || "01";

  // æ˜¾ç¤ºç”¨ï¼šæ›´å‹å¥½ä¸€ç‚¹
  let text;
  if (m[3]) {
    text = `${y}-${mo}-${d}`;
  } else if (m[2]) {
    text = `${y}-${mo}`;
  } else {
    text = y;
  }

  const key = `${y}${mo}${d}`;        // ç»†ç²’åº¦æ’åºç”¨
  const groupKey = `${y}${mo}`;      // å¹´æœˆåˆ†ç»„ç”¨
  const groupLabel = `${y.slice(2)}å¹´${parseInt(mo,10)}æœˆ`;  // å¦‚ã€Œ25å¹´1æœˆã€

  return { text, key, groupKey, groupLabel };
}

// æ¸²æŸ“åˆ—è¡¨ + å¹´æœˆåˆ†ç»„
function renderList(items) {
  const list    = document.getElementById("mhtmlList");
  const loading = document.getElementById("loading");
  const noRes   = document.getElementById("noResults");

  loading.style.display = "none";
  list.innerHTML = "";

  if (!items.length) {
    noRes.style.display = "block";
    return;
  }
  noRes.style.display = "none";

  // å…ˆæŒ‰ groupKey å½’ç»„
  const groups = {};
  for (const it of items) {
    const gKey   = it.dateGroupKey || "000000"; // æœªçŸ¥æ—¥æœŸç»„
    const gLabel = it.dateGroupLabel || "æœªçŸ¥æ—¥æœŸ";

    if (!groups[gKey]) {
      groups[gKey] = { label: gLabel, items: [] };
    }
    groups[gKey].items.push(it);
  }

  // åˆ†ç»„æ’åºï¼šæŒ‰å¹´æœˆå€’åºï¼ŒæœªçŸ¥æ—¥æœŸæ”¾æœ€å
  const groupKeys = Object.keys(groups).sort((a, b) => {
    if (a === "000000") return 1;
    if (b === "000000") return -1;
    return b.localeCompare(a);
  });

  // æ¸²æŸ“ï¼šæ¯ä¸ªç»„ä¸€ä¸ª group-header + è¯¥ç»„å†…æ‰€æœ‰æ¡ç›®
  for (const gKey of groupKeys) {
    const group = groups[gKey];

    // åˆ†ç»„æ ‡é¢˜
    const headerLi = document.createElement("li");
    headerLi.className = "group-header";
    headerLi.dataset.group = gKey;
    headerLi.textContent = group.label;
    list.appendChild(headerLi);

    // ç»„å†…æ’åºï¼šå…ˆæŒ‰ dateKey å†æŒ‰æ ‡é¢˜ï¼ˆåŒä¸€å¤©æŒ‰ä¸­æ–‡æ ‡é¢˜ï¼‰
    group.items.sort((a, b) => {
      if (a.dateKey !== b.dateKey) {
        return b.dateKey.localeCompare(a.dateKey);
      }
      return a.title.localeCompare(b.title, "zh");
    });

    // ç»„å†…æ–‡ä»¶
    for (const it of group.items) {
      const li = document.createElement("li");
      li.dataset.group  = gKey;
      li.dataset.search = (it.title + " " + it.dateText).toLowerCase();
      li.innerHTML = `
        ğŸ”– <a href="${it.url}" target="_blank">${it.title}</a>
        <div class="file-date">${it.dateText}</div>
      `;
      list.appendChild(li);
    }
  }
}

// æœç´¢é€»è¾‘ï¼šéšè—/æ˜¾ç¤ºæ–‡ä»¶ï¼ŒåŒæ—¶æŒ‰ç»„åˆ¤æ–­æ˜¯å¦éšè—åˆ†ç»„æ ‡é¢˜
function setupSearch() {
  const input = document.getElementById("searchInput");
  const noRes = document.getElementById("noResults");
  const loading = document.getElementById("loading");

  input.addEventListener("input", () => {
    const kw = input.value.trim().toLowerCase();
    let shown = 0;
    const groupVisibleCount = {};

    // å…ˆå¤„ç†æ–‡ä»¶é¡¹ï¼ˆé group-headerï¼‰
    document.querySelectorAll("#mhtmlList li").forEach(li => {
      if (li.classList.contains("group-header")) return;

      const text  = li.dataset.search || "";
      const ok    = !kw || text.includes(kw);
      li.style.display = ok ? "" : "none";
      if (ok) {
        shown++;
        const g = li.dataset.group;
        groupVisibleCount[g] = (groupVisibleCount[g] || 0) + 1;
      }
    });

    // å†æ ¹æ®æ¯ç»„æ˜¯å¦æœ‰å¯è§æ–‡ä»¶ï¼Œæ§åˆ¶ç»„æ ‡é¢˜æ˜¾ç¤º/éšè—
    document.querySelectorAll("#mhtmlList li.group-header").forEach(header => {
      const g = header.dataset.group;
      header.style.display = groupVisibleCount[g] ? "" : "none";
    });

    if (loading.style.display === "none") {
      noRes.style.display = shown ? "none" : "block";
    }
  });
}

// æŠŠ items å­˜åˆ°æœ¬åœ°ç¼“å­˜
function saveCache(items) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(items));
    localStorage.setItem(CACHE_TIME_KEY, String(Date.now()));
  } catch (e) {
    console.warn("æ— æ³•å†™å…¥ localStorageï¼š", e);
  }
}

// ä»ç¼“å­˜è¯»å–
function loadCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    const ts  = localStorage.getItem(CACHE_TIME_KEY);
    if (!raw || !ts) return null;
    const items = JSON.parse(raw);
    if (!Array.isArray(items)) return null;
    return { items, ts: Number(ts) };
  } catch (e) {
    console.warn("è¯»å–ç¼“å­˜å¤±è´¥ï¼š", e);
    return null;
  }
}

/* ========= GitHub API éƒ¨åˆ†ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰========= */
async function fetchFromGitHub() {
  const api = `https://api.github.com/repos/${owner}/${repo}/contents/${folder}`;
  const res = await fetch(api);
  if (!res.ok) throw new Error("GitHub API error " + res.status);

  const data = await res.json();
  if (!Array.isArray(data)) throw new Error("GitHub è¿”å›çš„ä¸æ˜¯æ•°ç»„");

  const items = data
    .filter(f =>
      f.type === "file" &&
      EXTS.some(ext => f.name.toLowerCase().endsWith(ext))
    )
    .map(f => {
      const date = extractDate(f.name);
      return {
        title: filenameToTitle(f.name),                 // âœ… æ ‡é¢˜ä¸å«æ—¥æœŸ
        dateText: date ? date.text : "æœªçŸ¥æ—¶é—´",         // âœ… åº•ä¸‹ç»¿è‰²å°å­—
        dateKey:  date ? date.key  : "00000000",
        dateGroupKey:   date ? date.groupKey   : "000000",
        dateGroupLabel: date ? date.groupLabel : "æœªçŸ¥æ—¥æœŸ",
        url: encodeURI(f.path)                          // å…¼å®¹ä¸­æ–‡è·¯å¾„
      };
    });

  return items;
}

/* ========= åˆå§‹åŒ–æµç¨‹ ========= */
async function init() {
  const loading = document.getElementById("loading");
  setupSearch();

  // 1. å…ˆç”¨ç¼“å­˜ï¼Œè®©é¡µé¢å°½å¿«æœ‰å†…å®¹
  const cached = loadCache();
  const now    = Date.now();

  if (cached && Array.isArray(cached.items)) {
    renderList(cached.items);
    if (now - cached.ts < CACHE_TTL_MS) {
      loading.textContent = "å·²åŠ è½½æœ¬åœ°ç¼“å­˜åˆ—è¡¨";
      return;
    } else {
      loading.textContent = "æ­£åœ¨å°è¯•ä» GitHub æ›´æ–°æœ€æ–°åˆ—è¡¨â€¦";
    }
  }

  // 2. ç¼“å­˜æ²¡æœ‰æˆ–è¿‡æœŸæ—¶ï¼Œå†æ‰“ GitHub API
  try {
    const items = await fetchFromGitHub();
    renderList(items);
    saveCache(items);
    loading.textContent = "åˆ—è¡¨å·²ä» GitHub æ›´æ–°";
  } catch (e) {
    console.error(e);
    if (cached && Array.isArray(cached.items)) {
      loading.textContent = "GitHub é™é¢æˆ–ç½‘ç»œå¼‚å¸¸ï¼Œå½“å‰æ˜¾ç¤ºçš„æ˜¯ä¸Šæ¬¡ç¼“å­˜çš„åˆ—è¡¨";
    } else {
      loading.textContent = "åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
    }
  }
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
